/*
 * Copyright (c) 2025
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;
#include <st/f4/stm32f405Xg.dtsi>
#include <st/f4/stm32f405rgtx-pinctrl.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <zephyr/dt-bindings/mipi_dbi/mipi_dbi.h>
#include <zephyr/dt-bindings/display/panel.h>
#include <zephyr/dt-bindings/lvgl/lvgl.h>

/ {
	model = "yopocho Mantel Clock";
	compatible = "yopocho,mantelclock";

	chosen {
		zephyr,console = &usart2;
		zephyr,shell-uart = &usart2;
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		// zephyr,flash-controller = &flash0;
		zephyr,dtcm = &ccm0;
		zephyr,display = &gc9a01;
	};

	leds {
		compatible = "gpio-leds";

		red_led: led_0 {
			gpios = <&gpioc 7 GPIO_ACTIVE_LOW>;
			label = "Debug LED Red";
		};
	};

	keys: keys {
		compatible = "gpio-keys";
		status = "okay";
		debounce-interval-ms = <30>;

		user_button_1: button_1 {
			label = "User button 1";
			gpios = <&gpiob 12 GPIO_ACTIVE_LOW>;
			zephyr,code = <INPUT_KEY_0>;
		};

        user_button_2: button_2 {
			label = "User button 2";
			gpios = <&gpiob 15 GPIO_ACTIVE_LOW>;
			zephyr,code = <INPUT_KEY_1>;
		};
	};

	lvgl_keypad_input {
		compatible = "zephyr,lvgl-keypad-input";
		input = <&keys>;
		input-codes = <INPUT_KEY_0 INPUT_KEY_1>;
		lvgl-codes = <LV_KEY_UP LV_KEY_NEXT>;
	};

	pwmleds {
		compatible = "pwm-leds";
		status = "okay";

		kathode_pwm: kathode_pwm {
			pwms = <&pwm2 3 PWM_USEC(20) PWM_POLARITY_NORMAL>;
		};
	};

	display_pwr_regulator: display_pwr_regulator {
		compatible = "regulator-fixed";
		status = "okay";
		regulator-name = "display-pwr-regulator";
		enable-gpios = <&gpiob 0 GPIO_ACTIVE_HIGH>;
		regulator-boot-on;
		startup-delay-us = <100000>;
		off-on-delay-us = <100000>; 
	};

	aliases {
		led0 = &red_led;
		kathodepwm = &kathode_pwm;
		gc9a01 = &gc9a01;
		sw0 = &user_button_1;
        sw1 = &user_button_2;
		die-temp0 = &die_temp;
		volt-sensor0 = &vref;
		volt-sensor1 = &vbat;
		rtc = &rtc;
	};

	my_mipi_dbi {
		compatible = "zephyr,mipi-dbi-spi";
		status = "okay";
		#address-cells = <1>;
		#size-cells = <0>;
		spi-dev = <&spi1>;
		dc-gpios = <&gpioa 3 GPIO_ACTIVE_HIGH>;
		reset-gpios = <&gpioc 4 GPIO_ACTIVE_LOW>;
		
		gc9a01: gc9a01@0 {
			compatible = "galaxycore,gc9x01x";
			reg = <0>;
			mipi-max-frequency = <DT_FREQ_M(100)>;
			pixel-format = <PANEL_PIXEL_FORMAT_RGB_565>;
			width = <240>;
			height = <240>;
			display-inversion;
		};
	};
};

&clk_lse {
	// compatible = "st,stm32-lse-clock"; //does this need adding?
	// clock-frequency = <32768>;
	status = "okay";
};

&clk_hse {
	clock-frequency = <DT_FREQ_M(25)>;
	status = "okay";
};

&pll {
	div-m = <15>;											// PLL input divider
	mul-n = <144>;											// PLL multiplier
	div-p = <2>;											// PLL output divider for main system clock
	div-q = <5>;		
	clocks = <&clk_hse>;
	status = "okay";
};

&rcc { //This might be wrong smh # ChatGPT
	clocks = <&pll>;
	clock-frequency = <DT_FREQ_M(120)>;
	ahb-prescaler = <1>;									// Division on AHB bus
	apb1-prescaler = <4>;									// Divide APB1 clock by 4 (max 50 MHz for STM32F4)
	apb2-prescaler = <2>;									// Division on APB2
};

&usart2 {
	status = "disabled";
};

&timers2 {
	// st,prescaler = <100>;
	status = "okay";

	pwm2: pwm {
		status = "okay";
		pinctrl-0 = <&tim2_ch3_pa2>;
		pinctrl-names = "default";
		
	};
};

&rtc {
	clocks = <&rcc STM32_CLOCK_BUS_APB1 0x10000000>,
		 	 <&rcc STM32_SRC_LSE RTC_SEL(1)>; // Is this correct?
	status = "okay";

	backup_regs {
		status = "okay";
	};
};

&die_temp {
	status = "okay";
};

&vref {
	status = "okay";
};

&vbat {
	status = "okay";
};

&dma1 {
	status = "okay";
};

&spi1 {
	pinctrl-0 = <&spi1_sck_pa5 &spi1_miso_pa6 &spi1_mosi_pa7>; // &spi1_nss_pa4 &spi1_sck_pa5 &spi1_miso_pa6 &spi1_mosi_pa7
	pinctrl-names = "default";
	cs-gpios = <&gpioa 4 GPIO_ACTIVE_LOW>;
	status = "okay";
};

&flash0 {
	status = "okay";
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		user_storage: partition@e0000 {
			label = "storage";
			reg = <0x000E0000 0x0000050>;
		};
	};
};
